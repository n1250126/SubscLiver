<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†</h1>
  <button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  <a href="pie-chart.html">ğŸ“Š å††ã‚°ãƒ©ãƒ•ã‚’è¦‹ã‚‹</a>

  <h3>æœˆé¡åˆè¨ˆï¼š<span id="total">Â¥0</span></h3>
  <canvas id="chart"style="max-width: 400px; max-height: 300px;"></canvas>

  <h3>è¿½åŠ  / ç·¨é›†</h3>
  <input id="service" placeholder="ã‚µãƒ¼ãƒ“ã‚¹å">
  <input id="price" type="number" placeholder="æ–™é‡‘">
  <select id="cycle">
    <option>æœˆé¡</option>
    <option>å¹´é¡</option>
  </select>
  <input id="nextBilling" type="date">
  <button onclick="save()">ä¿å­˜</button>

  <table border="1">
    <thead>
      <tr>
        <th>ã‚µãƒ¼ãƒ“ã‚¹</th>
        <th>æ–™é‡‘</th>
        <th>å‘¨æœŸ</th>
        <th>æ¬¡å›è«‹æ±‚</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAHqUmo2O6uKvaczMah4W02KZOLeoXo0SE",
  authDomain: "login-ceef8.firebaseapp.com",
  projectId: "login-ceef8",
  storageBucket: "login-ceef8.firebasestorage.app",
  messagingSenderId: "65863828111",
  appId: "1:65863828111:web:a0f98efedc50313747a6fa",
  //measurementId: "G-NQRD5JYY7B"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let subs = [];
    let editId = null;
    let chart;

    onAuthStateChanged(auth, user => {
      if (!user) {
        location.href = "login.html";
      } else {
        fetchSubs(user.uid);
      }
    });

    async function fetchSubs(uid) {
      const q = query(collection(db, "subscriptions"), where("userId", "==", uid));
      const snapshot = await getDocs(q);
      subs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      render();
    }

    function render() {
      tbody.innerHTML = "";
      let total = 0;

      subs.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${s.service}</td>
          <td>Â¥${s.price}</td>
          <td>${s.cycle}</td>
          <td>${s.nextBilling}</td>
          <td>
            <button onclick="edit('${s.id}')">ç·¨é›†</button>
            <button onclick="del('${s.id}')">å‰Šé™¤</button>
          </td>
        `;
        tbody.appendChild(tr);

        total += s.cycle === "æœˆé¡" ? s.price : s.price / 12;
      });

      total = Math.round(total);
      document.getElementById("total").textContent = "Â¥" + total;
      drawChart();
    }

    function drawChart() {
      const labels = subs.map(s => s.service);
      const data = subs.map(s => s.cycle === "æœˆé¡" ? s.price : Math.round(s.price / 12));

      if (chart) chart.destroy();
      chart = new Chart(document.getElementById("chart"), {
        type: "bar",
        data: { labels, datasets: [{ label: "æœˆé¡ã‚³ã‚¹ãƒˆ", data }] }
      });
    }

    async function save() {
      const user = auth.currentUser;
      if (!user) return;

      const body = {
        userId: user.uid,
        service: service.value,
        price: Number(price.value),
        cycle: cycle.value,
        nextBilling: nextBilling.value
      };

      if (editId) {
        await updateDoc(doc(db, "subscriptions", editId), body);
      } else {
        await addDoc(collection(db, "subscriptions"), body);
      }

      editId = null;
      fetchSubs(user.uid);
    }

    function edit(id) {
      const s = subs.find(x => x.id === id);
      service.value = s.service;
      price.value = s.price;
      cycle.value = s.cycle;
      nextBilling.value = s.nextBilling;
      editId = id;
    }

    async function del(id) {
      await deleteDoc(doc(db, "subscriptions", id));
      fetchSubs(auth.currentUser.uid);
    }

    async function logout() {
      await signOut(auth);
      location.href = "login.html";
    }

    window.save = save;
    window.edit = edit;
    window.del = del;
    window.logout = logout;
  </script>
</body>
</html>
