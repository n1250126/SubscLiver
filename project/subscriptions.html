<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« (å…±é€š) */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #f0f2f5;
      color: #333;
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    h1 {
      font-size: 24px;
      color: #202124;
      margin: 0;
    }

    .header-buttons {
      display: flex;
      gap: 10px;
    }

    /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .card {
      background-color: #fff;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 24px;
    }

    /* åˆè¨ˆé‡‘é¡è¡¨ç¤º */
    .summary-section {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .total-label { font-size: 14px; color: #666; }
    .total-amount { font-size: 32px; font-weight: bold; color: #1a73e8; margin: 8px 0; }

    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }

    /* ãƒãƒƒãƒ—ãƒ»å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
    .chips-label { font-size: 13px; color: #666; margin-bottom: 8px; font-weight: bold; }
    .chips-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
    .chip {
      background-color: #e8f0fe; color: #1a73e8; border: none; border-radius: 20px;
      padding: 6px 14px; font-size: 13px; cursor: pointer; transition: background-color 0.2s, transform 0.1s; font-weight: 500;
    }
    .chip:hover { background-color: #d2e3fc; }
    .chip:active { transform: scale(0.95); }

    .input-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
    input, select { padding: 10px; border: 1px solid #dadce0; border-radius: 4px; font-size: 14px; flex: 1; min-width: 120px; }
    input:focus, select:focus { border-color: #1a73e8; outline: none; }

    /* ãƒœã‚¿ãƒ³é¡ */
    button { padding: 10px 16px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 14px; transition: background-color 0.2s; }
    .btn-save { background-color: #1a73e8; color: white; width: 100%; }
    .btn-save:hover { background-color: #1557b0; }
    .btn-logout { background-color: #fff; color: #d93025; border: 1px solid #d93025; }
    .btn-logout:hover { background-color: #fce8e6; }
    .btn-notify { background-color: #fff; color: #fbbc04; border: 1px solid #fbbc04; }
    .btn-notify:hover { background-color: #fff8e1; }
    
    .btn-edit { background-color: #f1f3f4; color: #333; margin-right: 5px; }
    .btn-edit:hover { background-color: #e8eaed; }
    .btn-del { background-color: #fce8e6; color: #d93025; }
    .btn-del:hover { background-color: #fad2cf; }

    /* ãƒ†ãƒ¼ãƒ–ãƒ« */
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { text-align: left; font-size: 13px; color: #666; border-bottom: 2px solid #f0f2f5; padding: 12px 8px; }
    td { padding: 12px 8px; border-bottom: 1px solid #f0f2f5; font-size: 14px; }
    .text-right { text-align: right; }
    
    /* æœŸé™é–“è¿‘ã®ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º */
    .alert-date {
      color: #d93025; /* èµ¤æ–‡å­— */
      font-weight: bold;
    }
    .warning-icon {
      margin-right: 4px;
    }

    .chart-link { display: inline-block; margin-top: 10px; color: #1a73e8; text-decoration: none; font-size: 14px; }
    .chart-link:hover { text-decoration: underline; }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†</h1>
    <div class="header-buttons">
      <button id="btn-notify" class="btn-notify">ğŸ”” é€šçŸ¥ON</button>
      <button id="btn-logout" class="btn-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </header>

  <div class="card">
    <div class="summary-section">
      <div class="total-label">æœˆé¡åˆè¨ˆã‚³ã‚¹ãƒˆ</div>
      <div id="total" class="total-amount">Â¥0</div>
      <a href="pie-chart.html" class="chart-link">ğŸ“Š å††ã‚°ãƒ©ãƒ•ã§å†…è¨³ã‚’è¦‹ã‚‹</a>
    </div>
    <div class="chart-container">
      <canvas id="chart"></canvas>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-top: 0; margin-bottom: 16px;">ã‚µãƒ¼ãƒ“ã‚¹ã®è¿½åŠ  / ç·¨é›†</h3>
    
    <div class="chips-label">ã‚ˆãä½¿ã†ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠ:</div>
    <div class="chips-container">
      <button class="chip" onclick="setService('YouTube Premium')">YouTube Premium</button>
      <button class="chip" onclick="setService('Netflix')">Netflix</button>
      <button class="chip" onclick="setService('Amazon Prime')">Amazon Prime</button>
      <button class="chip" onclick="setService('Spotify')">Spotify</button>
      <button class="chip" onclick="setService('Apple Music')">Apple Music</button>
      <button class="chip" onclick="setService('Disney+')">Disney+</button>
      <button class="chip" onclick="setService('DAZN')">DAZN</button>
      <button class="chip" onclick="setService('ChatGPT Plus')">ChatGPT Plus</button>
    </div>

    <div class="input-group">
      <input id="service" type="text" placeholder="ã‚µãƒ¼ãƒ“ã‚¹å">
      <input id="price" type="number" placeholder="æ–™é‡‘ (å††)" min="0">
      <select id="cycle">
        <option value="æœˆé¡">æœˆé¡</option>
        <option value="å¹´é¡">å¹´é¡</option>
      </select>
      <input id="nextBilling" type="date">
    </div>
    <button id="btn-save" class="btn-save">ä¿å­˜ã™ã‚‹</button>

    <h3 style="margin-top: 32px; margin-bottom: 16px;">ç™»éŒ²æ¸ˆã¿ã‚µãƒ¼ãƒ“ã‚¹</h3>
    <table>
      <thead>
        <tr>
          <th>ã‚µãƒ¼ãƒ“ã‚¹</th>
          <th>æ–™é‡‘</th>
          <th>å‘¨æœŸ</th>
          <th>æ¬¡å›è«‹æ±‚</th>
          <th class="text-right">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where
  } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCLq-i3OTfFAInnpGwjLjEcn9McMgjAvmw",
    authDomain: "login-ceef8.firebaseapp.com",
    projectId: "login-ceef8",
    storageBucket: "login-ceef8.firebasestorage.app",
    messagingSenderId: "65863828111",
    appId: "1:65863828111:web:a0f98efedc50313747a6fa",
    measurementId: "G-NQRD5JYY7B"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let subs = [];
  let editId = null;
  let chart;

  onAuthStateChanged(auth, user => {
    if (!user) {
      location.href = "login.html";
    } else {
      fetchSubs(user.uid);
    }
  });

  async function fetchSubs(uid) {
    const q = query(collection(db, "subscriptions"), where("userId", "==", uid));
    const snapshot = await getDocs(q);
    subs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    render();
    checkBillingNotifications(); // ãƒ‡ãƒ¼ã‚¿å–å¾—å¾Œã«é€šçŸ¥ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
  }

  function render() {
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";
    let total = 0;
    const today = new Date();
    today.setHours(0,0,0,0); // æ™‚é–“ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ—¥ä»˜æ¯”è¼ƒç”¨ã«ã™ã‚‹

    subs.forEach(s => {
      // æ¬¡å›è«‹æ±‚æ—¥ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
      let dateDisplay = '-';
      let isNear = false;
      let daysLeft = null;

      if (s.nextBilling) {
        const billingDate = new Date(s.nextBilling);
        billingDate.setHours(0,0,0,0);
        
        const diffTime = billingDate - today;
        daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

        dateDisplay = s.nextBilling;

        // 7æ—¥ä»¥å†…ã€ã‹ã¤éå»ã®æ—¥ä»˜ã§ãªã„å ´åˆè­¦å‘Š
        if (daysLeft >= 0 && daysLeft <= 7) {
          isNear = true;
          dateDisplay = `<span class="alert-date">âš ï¸ ${s.nextBilling} (ã‚ã¨${daysLeft}æ—¥)</span>`;
        } else if (daysLeft < 0) {
           // éãã¦ã„ã‚‹å ´åˆ
           dateDisplay = `<span style="color:#999">${s.nextBilling} (éãã¦ã„ã¾ã™)</span>`;
        }
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${s.service}</td>
        <td>Â¥${s.price.toLocaleString()}</td>
        <td>${s.cycle}</td>
        <td>${dateDisplay}</td>
        <td class="text-right">
          <button class="btn-edit" onclick="edit('${s.id}')">ç·¨é›†</button>
          <button class="btn-del" onclick="del('${s.id}')">å‰Šé™¤</button>
        </td>
      `;
      tbody.appendChild(tr);

      total += s.cycle === "æœˆé¡" ? Number(s.price) : Number(s.price) / 12;
    });

    total = Math.round(total);
    document.getElementById("total").textContent = "Â¥" + total.toLocaleString();
    drawChart();
  }

  // --- é€šçŸ¥æ©Ÿèƒ½ ---
  
  // 1. é€šçŸ¥è¨±å¯ã‚’æ±‚ã‚ã‚‹
  async function requestNotificationPermission() {
    if (!("Notification" in window)) {
      alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
      return;
    }
    
    const permission = await Notification.requestPermission();
    if (permission === "granted") {
      alert("é€šçŸ¥ãŒã‚ªãƒ³ã«ãªã‚Šã¾ã—ãŸï¼è«‹æ±‚æ—¥ãŒè¿‘ã¥ãã¨ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚");
      checkBillingNotifications(); // è¨±å¯ç›´å¾Œã«ã‚‚ãƒã‚§ãƒƒã‚¯
    } else {
      alert("é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚");
    }
  }

  // 2. æ—¥ä»˜ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦é€šçŸ¥ã‚’å‡ºã™
  function checkBillingNotifications() {
    if (!("Notification" in window) || Notification.permission !== "granted") {
      return;
    }

    const today = new Date();
    today.setHours(0,0,0,0);

    subs.forEach(s => {
      if (!s.nextBilling) return;
      
      const billingDate = new Date(s.nextBilling);
      billingDate.setHours(0,0,0,0);
      
      const diffTime = billingDate - today;
      const daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      // 7æ—¥ä»¥å†…ãªã‚‰é€šçŸ¥
      if (daysLeft >= 0 && daysLeft <= 7) {
        new Notification("æ”¯æ‰•æ—¥ãŒè¿‘ã¥ã„ã¦ã„ã¾ã™ ğŸ’¸", {
          body: `${s.service}ã®æ”¯æ‰•æ—¥ãŒ${daysLeft === 0 ? 'ä»Šæ—¥' : 'ã‚ã¨' + daysLeft + 'æ—¥å¾Œ'}ã§ã™ã€‚`,
          icon: "https://cdn-icons-png.flaticon.com/512/3135/3135715.png" // ãŠé‡‘ã®ã‚¢ã‚¤ã‚³ãƒ³ä¾‹
        });
      }
    });
  }

  function drawChart() {
    const labels = subs.map(s => s.service);
    const data = subs.map(s => s.cycle === "æœˆé¡" ? s.price : Math.round(s.price / 12));

    if (chart) chart.destroy();
    
    const ctx = document.getElementById("chart").getContext('2d');
    chart = new Chart(ctx, {
      type: "bar",
      data: { 
        labels, 
        datasets: [{ 
          label: "æœˆé¡æ›ç®—ã‚³ã‚¹ãƒˆ", 
          data,
          backgroundColor: '#4285F4',
          borderRadius: 4
        }] 
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  async function save() {
    const user = auth.currentUser;
    if (!user) return;

    const serviceInput = document.getElementById('service');
    const priceInput = document.getElementById('price');
    const cycleInput = document.getElementById('cycle');
    const nextBillingInput = document.getElementById('nextBilling');

    if (Number(priceInput.value) < 0) {
      alert("æ–™é‡‘ã¯0ä»¥ä¸Šã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    if(!serviceInput.value || !priceInput.value) {
      alert("ã‚µãƒ¼ãƒ“ã‚¹åã¨æ–™é‡‘ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    const body = {
      userId: user.uid,
      service: serviceInput.value,
      price: Number(priceInput.value),
      cycle: cycleInput.value,
      nextBilling: nextBillingInput.value
    };

    try {
      if (editId) {
        await updateDoc(doc(db, "subscriptions", editId), body);
      } else {
        await addDoc(collection(db, "subscriptions"), body);
      }
      
      serviceInput.value = "";
      priceInput.value = "";
      nextBillingInput.value = "";
      editId = null;
      document.getElementById('btn-save').textContent = "ä¿å­˜ã™ã‚‹";

      fetchSubs(user.uid);
    } catch (e) {
      console.error("Error adding document: ", e);
      alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    }
  }

  function edit(id) {
    const s = subs.find(x => x.id === id);
    if (!s) return;
    document.getElementById('service').value = s.service;
    document.getElementById('price').value = s.price;
    document.getElementById('cycle').value = s.cycle;
    document.getElementById('nextBilling').value = s.nextBilling;
    
    editId = id;
    document.getElementById('btn-save').textContent = "æ›´æ–°ã™ã‚‹";
    
    document.querySelector('.input-group').scrollIntoView({behavior: "smooth"});
  }

  async function del(id) {
    if(!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    await deleteDoc(doc(db, "subscriptions", id));
    fetchSubs(auth.currentUser.uid);
  }

  async function logout() {
    await signOut(auth);
    location.href = "login.html";
  }

  function setService(name) {
    document.getElementById('service').value = name;
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  document.getElementById('btn-save').addEventListener('click', save);
  document.getElementById('btn-logout').addEventListener('click', logout);
  document.getElementById('btn-notify').addEventListener('click', requestNotificationPermission); // é€šçŸ¥è¨±å¯ãƒœã‚¿ãƒ³

  window.edit = edit;
  window.del = del;
  window.setService = setService;

</script>
</body>
</html>